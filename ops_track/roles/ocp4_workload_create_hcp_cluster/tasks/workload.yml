---
# ==============================================================================
# DEBUG - Pre-flight checks for HCP cluster creation
# ==============================================================================
- name: DEBUG - HCP cluster creation input variables
  debug:
    msg:
      - "=== HCP CLUSTER CONFIG ==="
      - "cluster_name: {{ ocp4_workload_create_hcp_cluster_name }}"
      - "namespace: {{ ocp4_workload_create_hcp_cluster_namespace }}"
      - "release_image: {{ ocp4_workload_create_hcp_cluster_release_image }}"
      - "etcd_storage_class: {{ ocp4_workload_create_hcp_cluster_etcd_storage_class }}"
      - "etcd_storage_size: {{ ocp4_workload_create_hcp_cluster_etcd_storage_size }}"
      - "network_cidr: {{ ocp4_workload_create_hcp_cluster_network_cidr }}"
      - "service_network_cidr: {{ ocp4_workload_create_hcp_cluster_service_network_cidr }}"
      - "base_domain: {{ ocp4_workload_create_hcp_cluster_base_domain }}"
      - "availability: {{ ocp4_workload_create_hcp_cluster_availability }}"
      - "timeout: {{ ocp4_workload_create_hcp_cluster_timeout }}"
  ignore_errors: true

- name: DEBUG - Verify etcd storage class exists
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: "{{ ocp4_workload_create_hcp_cluster_etcd_storage_class }}"
  register: debug_storage_class
  ignore_errors: true

- name: DEBUG - Display storage class check
  debug:
    msg:
      - "=== STORAGE CLASS CHECK ==="
      - "requested: {{ ocp4_workload_create_hcp_cluster_etcd_storage_class }}"
      - "exists: {{ debug_storage_class.resources | default([]) | length > 0 }}"
  when: debug_storage_class is defined
  ignore_errors: true

- name: DEBUG - List all available storage classes
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
  register: debug_all_sc
  ignore_errors: true

- name: DEBUG - Display all storage classes
  debug:
    msg:
      - "=== ALL STORAGE CLASSES ==="
      - "{{ debug_all_sc.resources | default([]) | map(attribute='metadata') | map(attribute='name') | list }}"
  when: debug_all_sc is defined
  ignore_errors: true

- name: DEBUG - Check MetalLB IP address pool
  kubernetes.core.k8s_info:
    api_version: metallb.io/v1beta1
    kind: IPAddressPool
  register: debug_ip_pool
  ignore_errors: true

- name: DEBUG - Display MetalLB IP pools
  debug:
    msg:
      - "=== METALLB IP POOLS ==="
      - "count: {{ debug_ip_pool.resources | default([]) | length }}"
      - "pools: {{ debug_ip_pool.resources | default([]) | map(attribute='metadata') | map(attribute='name') | list }}"
  when: debug_ip_pool is defined
  ignore_errors: true

# ==============================================================================
# HCP Cluster Creation
# ==============================================================================
- name: Verify HyperShift operator is running
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: hypershift
    label_selectors:
      - app=operator
  register: r_hypershift_operator
  retries: 30
  delay: 10
  until: r_hypershift_operator.resources | length > 0

- name: Create clusters namespace
  kubernetes.core.k8s:
    state: present
    api_version: v1
    kind: Namespace
    name: "{{ ocp4_workload_create_hcp_cluster_namespace }}"

- name: Retrieve pull-secret from openshift-config
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: pull-secret
    namespace: openshift-config
  register: r_pull_secret

- name: Create pull secret for hosted cluster
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "pullsecret-cluster-{{ ocp4_workload_create_hcp_cluster_name }}"
        namespace: "{{ ocp4_workload_create_hcp_cluster_namespace }}"
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: "{{ r_pull_secret.resources[0].data['.dockerconfigjson'] }}"

- name: Create SSH key secret for hosted cluster
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "sshkey-cluster-{{ ocp4_workload_create_hcp_cluster_name }}"
        namespace: "{{ ocp4_workload_create_hcp_cluster_namespace }}"
      type: Opaque
      stringData:
        id_rsa.pub: ""

- name: Create HostedCluster
  kubernetes.core.k8s:
    state: present
    template: hostedcluster.yaml.j2

- name: DEBUG - Check etcd PVC status after HostedCluster creation
  kubernetes.core.k8s_info:
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: "clusters-{{ ocp4_workload_create_hcp_cluster_name }}"
  register: debug_etcd_pvcs
  ignore_errors: true

- name: DEBUG - Display etcd PVC status
  debug:
    msg:
      - "=== ETCD PVCs ==="
      - "namespace: clusters-{{ ocp4_workload_create_hcp_cluster_name }}"
      - "count: {{ debug_etcd_pvcs.resources | default([]) | length }}"
      - "pvcs: {{ debug_etcd_pvcs.resources | default([]) | map(attribute='metadata') | map(attribute='name') | list }}"
      - "phases: {{ debug_etcd_pvcs.resources | default([]) | map(attribute='status') | map(attribute='phase', default='Unknown') | list }}"
  when: debug_etcd_pvcs is defined
  ignore_errors: true

- name: DEBUG - Check HostedCluster initial conditions
  kubernetes.core.k8s_info:
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    name: "{{ ocp4_workload_create_hcp_cluster_name }}"
    namespace: "{{ ocp4_workload_create_hcp_cluster_namespace }}"
  register: debug_hc_initial
  ignore_errors: true

- name: DEBUG - Display HostedCluster initial conditions
  debug:
    msg:
      - "=== HOSTEDCLUSTER INITIAL STATUS ==="
      - "{{ debug_hc_initial.resources[0].status.conditions | default([]) | map(attribute='type') | zip(debug_hc_initial.resources[0].status.conditions | default([]) | map(attribute='status')) | map('join', '=') | list }}"
      - "=== PROBLEM CONDITIONS ==="
      - "{{ debug_hc_initial.resources[0].status.conditions | default([]) | selectattr('status', 'equalto', 'False') | map(attribute='type') | zip(debug_hc_initial.resources[0].status.conditions | default([]) | selectattr('status', 'equalto', 'False') | map(attribute='message')) | map('join', ': ') | list }}"
  when:
    - debug_hc_initial is defined
    - debug_hc_initial.resources | default([]) | length > 0
    - debug_hc_initial.resources[0].status is defined
  ignore_errors: true

- name: Wait for HostedCluster to become available
  block:
    - name: Poll HostedCluster until Available
      kubernetes.core.k8s_info:
        api_version: hypershift.openshift.io/v1beta1
        kind: HostedCluster
        name: "{{ ocp4_workload_create_hcp_cluster_name }}"
        namespace: "{{ ocp4_workload_create_hcp_cluster_namespace }}"
      register: r_hosted_cluster
      retries: "{{ (ocp4_workload_create_hcp_cluster_timeout | int / 10) | int }}"
      delay: 10
      until:
        - r_hosted_cluster.resources | length > 0
        - r_hosted_cluster.resources[0].status is defined
        - r_hosted_cluster.resources[0].status.conditions is defined
        - r_hosted_cluster.resources[0].status.conditions | selectattr('type', 'equalto', 'Available') | selectattr('status', 'equalto', 'True') | list | length > 0
  rescue:
    - name: DEBUG - Post-failure HCP cluster state
      shell: |
        echo "=== HCP CLUSTER WAIT FAILED - COLLECTING DIAGNOSTICS ==="
        echo ""
        echo "=== HOSTEDCLUSTER CONDITIONS ==="
        oc get hostedcluster {{ ocp4_workload_create_hcp_cluster_name }} -n {{ ocp4_workload_create_hcp_cluster_namespace }} -o jsonpath='{range .status.conditions[*]}{.type}={.status} | {.reason} | {.message}{"\n"}{end}' 2>/dev/null || echo "HostedCluster not found"
        echo ""
        echo "=== HCP CONTROL PLANE PODS ==="
        oc get pods -n clusters-{{ ocp4_workload_create_hcp_cluster_name }} -o wide 2>/dev/null | head -40 || echo "No HCP namespace"
        echo ""
        echo "=== PENDING/FAILED HCP PODS ==="
        oc get pods -n clusters-{{ ocp4_workload_create_hcp_cluster_name }} --field-selector=status.phase!=Running,status.phase!=Succeeded --no-headers 2>/dev/null | head -20 || echo "All pods running"
        echo ""
        echo "=== HCP PVCs ==="
        oc get pvc -n clusters-{{ ocp4_workload_create_hcp_cluster_name }} -o custom-columns=NAME:.metadata.name,STATUS:.status.phase,CAPACITY:.status.capacity.storage,STORAGECLASS:.spec.storageClassName 2>/dev/null || echo "No PVCs"
        echo ""
        echo "=== HCP EVENTS (last 30) ==="
        oc get events -n clusters-{{ ocp4_workload_create_hcp_cluster_name }} --sort-by='.lastTimestamp' 2>/dev/null | tail -30 || echo "No events"
        echo ""
        echo "=== ETCD STATEFULSET ==="
        oc get statefulset -n clusters-{{ ocp4_workload_create_hcp_cluster_name }} 2>/dev/null || echo "No StatefulSets"
        echo ""
        echo "=== NODE RESOURCE USAGE ==="
        oc adm top nodes 2>/dev/null || echo "Metrics not available"
        echo ""
        echo "=== STORAGE CLASSES ==="
        oc get sc 2>/dev/null || echo "Failed"
      register: debug_hcp_failure
      ignore_errors: true

    - name: DEBUG - Display post-failure HCP diagnostics
      debug:
        msg: "{{ debug_hcp_failure.stdout_lines | default(['no output']) }}"
      when: debug_hcp_failure is defined
      ignore_errors: true

    - name: Fail with clear message
      fail:
        msg: "HCP HostedCluster did not become available within {{ ocp4_workload_create_hcp_cluster_timeout }} seconds. See diagnostics above."

- name: Get hosted cluster kubeconfig secret name
  set_fact:
    _hcp_kubeconfig_secret: "{{ ocp4_workload_create_hcp_cluster_name }}-admin-kubeconfig"

- name: Retrieve hosted cluster kubeconfig
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ _hcp_kubeconfig_secret }}"
    namespace: "{{ ocp4_workload_create_hcp_cluster_namespace }}"
  register: r_hcp_kubeconfig

- name: Extract hosted cluster API URL from kubeconfig
  set_fact:
    _hcp_api_url: "{{ r_hcp_kubeconfig.resources[0].data.kubeconfig | b64decode | from_yaml | json_query('clusters[0].cluster.server') }}"

- name: Save HCP cluster information as user data
  agnosticd.core.agnosticd_user_info:
    data:
      hcp_cluster_name: "{{ ocp4_workload_create_hcp_cluster_name }}"
      hcp_cluster_namespace: "{{ ocp4_workload_create_hcp_cluster_namespace }}"
      hcp_kubeconfig_secret: "{{ _hcp_kubeconfig_secret }}"
      hcp_api_url: "{{ _hcp_api_url }}"

- name: HCP cluster creation complete
  debug:
    msg: >-
      Hosted cluster '{{ ocp4_workload_create_hcp_cluster_name }}'
      created successfully in namespace '{{ ocp4_workload_create_hcp_cluster_namespace }}'.
      API URL: {{ _hcp_api_url }}
  when: not silent | bool
