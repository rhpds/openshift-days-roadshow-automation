---
# ==============================================================================
# DIAGNOSTICS - Cluster state before this workload
# ==============================================================================
- name: "DIAG - Cluster state checkpoint"
  shell: |
    echo "=== NODE USAGE ==="
    oc adm top nodes 2>/dev/null || echo "Metrics not available"
    echo ""
    echo "=== PODS: Running=$(oc get pods -A --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l) Pending=$(oc get pods -A --field-selector=status.phase=Pending --no-headers 2>/dev/null | wc -l) Failed=$(oc get pods -A --field-selector=status.phase=Failed --no-headers 2>/dev/null | wc -l) Total=$(oc get pods -A --no-headers 2>/dev/null | wc -l) ==="
    echo ""
    echo "=== PENDING PODS ==="
    oc get pods -A --field-selector=status.phase=Pending --no-headers 2>/dev/null | head -10 || echo "None"
    echo ""
    echo "=== CSVs NOT SUCCEEDED ==="
    oc get csv -A --no-headers 2>/dev/null | grep -v Succeeded | head -10 || echo "All succeeded"
    echo ""
    echo "=== PENDING PVCs ==="
    oc get pvc -A --field-selector=status.phase!=Bound --no-headers 2>/dev/null | head -10 || echo "All bound"
    echo ""
    echo "=== DEGRADED CLUSTER OPERATORS ==="
    oc get co -o json 2>/dev/null | python3 -c "
    import sys, json
    data = json.load(sys.stdin)
    for co in data.get('items', []):
        name = co['metadata']['name']
        conds = {c['type']: c for c in co.get('status', {}).get('conditions', [])}
        avail = conds.get('Available', {}).get('status', 'Unknown')
        degrade = conds.get('Degraded', {}).get('status', 'Unknown')
        if avail != 'True' or degrade == 'True':
            print(f'{name}: Available={avail} Degraded={degrade}')
    " 2>/dev/null || echo "Failed"
    echo ""
    echo "=== RECENT WARNINGS (last 10) ==="
    oc get events -A --field-selector type=Warning --sort-by='.lastTimestamp' --no-headers 2>/dev/null | tail -10 || echo "None"
  register: diag_pre_workload
  ignore_errors: true

- name: "DIAG - Display pre-workload state"
  debug:
    msg: "{{ diag_pre_workload.stdout_lines | default(['no output']) }}"
  when: diag_pre_workload is defined
  ignore_errors: true

